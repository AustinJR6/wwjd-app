rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ” Users collection
    // Allow all authenticated users to read basic user info (for leaderboards)
    // but restrict writes to the owner of the document
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ’¬ Religion Chats
    match /religionChats/{userId}/messages/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ•Šï¸ Temp Religion Chat (non-subscribed users)
    match /tempReligionChat/{userId}/messages/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ™ Confessional Sessions
    match /confessionalSessions/{userId}/messages/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ’³ Subscriptions
    match /subscriptions/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸª™ Tokens (user-scoped)
    match /tokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸª™ Global token settings
    match /tokens/settings {
      allow read: if request.auth != null;
    }

    // ğŸ§® Free Ask usage tracker
    match /freeAsk/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ““ Journal Entries (new nested format)
    match /users/{userId}/journalEntries/{entryId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ““ Top-level journal collection
    // Path: journalEntries/{userId}/entries/{docId}
    match /journalEntries/{userId}/entries/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ“… Challenge History (per user)
    match /users/{userId}/challengeHistory/{entryId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ“ Journal streak tracking (per user)
    // Document stored under users/{uid}/journalStreak/current
    match /users/{userId}/journalStreak/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ” Active Challenge (per user)
    // Allows read/write access to documents under
    // `users/{uid}/activeChallenge`, including the `current` doc
    match /users/{userId}/activeChallenge/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Convenience rule for the common `current` document
    match /users/{userId}/activeChallenge/current {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ“† Daily Challenges (read-only)
    match /dailyChallenges/{dayId} {
      allow read: if true;
    }

    // ğŸ“Š Active Challenges collection (readable if authed)
    match /activeChallenges/{docId} {
      allow read: if request.auth != null;
    }

    // ğŸ Completed Challenges (per user)
    match /completedChallenges/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ¢ Organization docs (open to all authed users)
    match /organizations/{orgId} {
      allow read, write: if request.auth != null;
    }

    // ğŸŒ Regions (read-only for authed users)
    match /regions/{regionId} {
      allow read: if request.auth != null;
    }

    // ğŸ› Public religion content
    match /religion/{religionId} {
      allow read: if true;
    }

    // ğŸ† Leaderboards
    // Allow all authenticated users to read and write the global leaderboard
    match /leaderboards/global {
      allow read, write: if request.auth != null;
    }
    match /leaderboards/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // ğŸ“¸ Challenge Proof submissions
    match /challengeProofs/{proofId} {
      allow write: if request.auth != null && request.resource.data.uid == request.auth.uid;
      allow read: if request.auth != null;
    }

    // âŒ Catch-all: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

